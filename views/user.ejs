<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .welcome-message {
            font-size: 24px;
            margin-bottom: 20px;
        }
        .button {
            padding: 10px 20px;
            margin-right: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .button.logout {
            background-color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
    <div class="welcome-message">
        Welcome, <%= username %>!
    </div>
    <p>This is your user page.</p>
    <p>You can manage your listings here.</p>
    <button class="button" onclick="backToHome()">Back to Home</button>
    <button class="button logout" onclick="logout()">Logout</button>

    <h2>Add New Listing</h2>
    <div id="addListingForm">
        <form onsubmit="addListing(event)">
            <label for="price">Price:</label><br>
            <input type="text" id="priceInput" name="price" required><br>
            <label for="squareFootage">Square Footage:</label><br>
            <input type="text" id="squareFootageInput" name="squareFootage" required><br>
            <label for="numBedrooms">Number of Bedrooms:</label><br>
            <select id="numBedroomsInput" name="numBedrooms" required>
                <option value="">Select</option>
                <% for (let i = 0; i <= 10; i++) { %>
                    <option value="<%= i %>"><%= i %></option>
                <% } %>
            </select><br>
            <label for="numBathrooms">Number of Bathrooms:</label><br>
            <select id="numBathroomsInput" name="numBathrooms" required>
                <option value="">Select</option>
                <% for (let i = 0; i <= 10; i++) { %>
                    <option value="<%= i %>"><%= i %></option>
                <% } %>
            </select><br>
            <label for="propertyType">Property Type:</label><br>
            <select id="propertyTypeInput" name="propertyType" required>
                <option value="">Select</option>
                <option value="SINGLE_FAMILY_RESIDENTIAL">Single Family Residential</option>
                <option value="CONDO_COOP">Condo/Coop</option>
                <option value="TOWNHOUSE">Townhouse</option>
                <option value="MULTI_FAMILY_2_TO_4">Multi-Family (2 to 4)</option>
                <option value="MULTI_FAMILY_5_PLUS">Multi-Family (5 or more)</option>
            </select><br>
            <label for="yearBuilt">Year Built:</label><br>
            <select id="yearBuiltInput" name="yearBuilt" required>
                <option value="">Select</option>
                <% for (let year = 1900; year <= 2024; year++) { %>
                    <option value="<%= year %>"><%= year %></option>
                <% } %>
            </select><br>
            <input type="submit" value="Add Listing">
        </form>
    </div>
</div>

<script>
    function addListing(event) {
        event.preventDefault();
        const price = document.getElementById('priceInput').value;
        const squareFootage = document.getElementById('squareFootageInput').value;
        const numBedrooms = document.getElementById('numBedroomsInput').value;
        const numBathrooms = document.getElementById('numBathroomsInput').value;
        const propertyType = document.getElementById('propertyTypeInput').value;
        const yearBuilt = document.getElementById('yearBuiltInput').value;
        
        // Prepare data for adding listing to Properties table
        const data = {
            price: price,
            squareFootage: squareFootage,
            numBedrooms: numBedrooms,
            numBathrooms: numBathrooms,
            propertyType: propertyType,
            yearBuilt: yearBuilt
        };

        // Add listing to Properties table
        fetch('/properties', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Failed to add property');
            }
        })
        .then(result => {
            // Get the propertyId of the added property
            const propertyId = result.propertyId;
            
            // Prepare data for adding listing to UserListings table
            const userData = {
                userId: '<%= userid %>', // Assuming userId is available from the server
                propertyId: propertyId
            };

            // Add listing to UserListings table
            fetch('/user/listings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            })
            .then(response => {
                if (response.ok) {
                    alert('Listing added successfully');
                    // Optionally, you can perform additional actions here
                } else {
                    throw new Error('Failed to add listing to UserListings');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to add listing to UserListings');
            });
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add property');
        });
    }

        function logout() {
            // Perform logout actions here
            alert('Logging out...');
            // Redirect to homepage
            window.location.href = '/';
        }

        function backToHome() {
            // Redirect to home page with username in URL
            window.location.href = '/?username=<%= username %>&userid=<%= userid %>';
        }
</script>
</body>
</html>
